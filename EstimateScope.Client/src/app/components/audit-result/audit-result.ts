import { Component, Input, inject } from '@angular/core'; // Tambah inject
import { CommonModule } from '@angular/common';
import jsPDF from 'jspdf';
import autoTable from 'jspdf-autotable';
import { LangService } from '../../services/lang.service'; // Import Service

@Component({
  selector: 'app-audit-result',
  standalone: true,
  imports: [CommonModule],
  templateUrl: './audit-result.html'
})
export class AuditResultComponent {
  lang = inject(LangService); // INJECT SERVICE BAHASA

  @Input() data: any[] = [];
  @Input() riskLevel: string = 'Low';
  @Input() projectInfo: any = {}; 

  // Update Warna Badge Resiko
  get riskColorClass() {
    switch (this.riskLevel?.toLowerCase()) {
      case 'high': return 'bg-red-100 text-red-700 border-red-200'; // Merah (Bahaya)
      case 'medium': return 'bg-orange-50 text-orange-600 border-orange-100'; // Orange (Sedang)
      default: return 'bg-emerald-50 text-emerald-600 border-emerald-100'; // Hijau (Aman)
    }
  }

  downloadPDF() {
    const doc = new jsPDF();

    // 1. Header Laporan (Ganti warna jadi MERAH: 220, 38, 38)
    doc.setFontSize(18);
    doc.setTextColor(220, 38, 38); 
    doc.text('EstimateScope AI - Project Audit Report', 14, 20);
    
    // 2. Info Project
    doc.setFontSize(10);
    doc.setTextColor(100);
    doc.text(`Project Type: ${this.projectInfo.projectType || 'N/A'}`, 14, 30);
    doc.text(`Hourly Rate: $${this.projectInfo.hourlyRate || 0}/hr`, 14, 35);
    
    // Risk Level (Logic Warna di PDF)
    doc.text(`Risk Level: ${this.riskLevel}`, 14, 40);

    // 3. Data Tabel
    const tableRows = this.data.map(item => [
      item.taskName,
      `${item.estimatedHours}h`,
      `$${item.estimatedCost}`,
      item.outOfScope
    ]);

    // 4. Render Tabel (Theme Merah)
    autoTable(doc, {
      startY: 50,
      head: [['Task Breakdown', 'Hours', 'Est. Cost', 'Out of Scope / Notes']],
      body: tableRows,
      theme: 'grid',
      headStyles: { 
        fillColor: [220, 38, 38], // Header Tabel Merah
        textColor: 255 
      },
      styles: { fontSize: 9 },
      columnStyles: {
        0: { cellWidth: 60 }, // Task Name
        3: { cellWidth: 'auto' } // Out of Scope
      }
    });

    // 5. Footer Copyright
    const pageCount = (doc as any).internal.getNumberOfPages();
    for(let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(150);
        doc.text('Generated by EstimateScope AI', 14, doc.internal.pageSize.height - 10);
    }

    doc.save(`Audit_${this.projectInfo.projectType || 'Project'}.pdf`);
  }
}